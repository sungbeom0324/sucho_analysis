#!/usr/bin/env bash

# ------------------------------------------------------------
# 0) set_env.sh가 source 되었는지 체크
# ------------------------------------------------------------
if [ -z "$SLIM_DIR" ]; then
    echo "[ERROR] Environment not set."
    echo "Run: source set_env.sh"
    exit 1
fi

# ------------------------------------------------------------
# 1) 입력 ROOT 파일
# ------------------------------------------------------------
INPUT_FILE="$1"

if [ -z "$INPUT_FILE" ]; then
    echo "[ERROR] No input file given"
    exit 1
fi

echo "[INFO] Starting slim for: ${INPUT_FILE}"
date

# ------------------------------------------------------------
# 2) ROOT 환경
# ------------------------------------------------------------
source /cvmfs/sft.cern.ch/lcg/releases/LCG_106a/ROOT/6.32.06/x86_64-el9-gcc13-opt/ROOT-env.sh

# ------------------------------------------------------------
# 3) Condor 작업 디렉토리
# ------------------------------------------------------------
CID=${ClusterId:-local}
PID=${ProcId:-$$}
WORKDIR="/tmp/${USER}/slim_${CID}_${PID}"

mkdir -p "${WORKDIR}" || exit 1

# ------------------------------------------------------------
# 4) 소스 복사 (절대경로 제거됨)
# ------------------------------------------------------------
cp "${SLIM_DIR}/slim_single.C" "${WORKDIR}/" || exit 1
cp -r "${ANALYSIS_BASE}/include" "${WORKDIR}/" || exit 1

# ------------------------------------------------------------
# 5) 이동
# ------------------------------------------------------------
cd "${WORKDIR}" || exit 1

# ------------------------------------------------------------
# 6) 출력 디렉토리 (repo 기준)
# ------------------------------------------------------------
BASE_OUT="${SLIM_DIR}/../output/slimmed"
mkdir -p "${BASE_OUT}"

# ------------------------------------------------------------
# 7) 실행
# ------------------------------------------------------------
root -b -q "slim_single.C+(\"${INPUT_FILE}\", \"${BASE_OUT}\")"
RET=$?

echo "[INFO] ROOT exited with code: ${RET}"
date

exit ${RET}
